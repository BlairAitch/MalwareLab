# Introduction
This is a virtual lab set up using Oracle VirtualBox 6.1.22, the goal is to have a functional malware analysis lab.  The aim of this write-up is not to produce a step-by-step guide to reproduce this lab, just to give an overview of what the lab consists of.

## Network Structure
Our lab will consist of 4 network segments; 
- our Bridged Network which corresponds to the local network used at home, this is the network our hypervisor is on;
- the Management Network (172.16.1.0/24) which our hypervisor host will have a direct connection to using a virtual network card attached to our host machine, this where we’ll manage most of the VMs in our lab from;
- the IPS1 and IPS2 segments which share a range (172.16.2.0/24) and are connected through an AFPACKET bridge supplied by our IPS VM, this allows us to quarantine the IPS2 segment at will by either killing the IPS VM or killing the Snort service running on it.
<p align="center">
  <img src="https://github.com/BlairAitch/MalwareLab/blob/main/CroppedMalwareLab.png" width="480" height="600">
</p>

## Firewall
We’re using the pfSense Community Edition 2.5.2 distribution.  We’ll have 3 interfaces defined on our firewall;
- WAN, which will be connected to our Bridged network, providing access to the internet.
- LAN, which will be connected to the Management segment of our lab network.
- OPT1, which will be connected to the IPS1 segment.
This VM will be responsible for routing between our network segments, NAC through the use of firewall rules, and providing DHCP, DNS, NTP and HTTP proxy network services for our VMs.

## SIEM VM
We’ll be setting up Splunk to collect logs via a forwarder set up on our IPS VM, we’ll then be able to index and analyse traffic on the IPS1 and IPS2 segments of our network using the web searchhead.

## IPS VM
This is the VM that we’re going to have our IPS software Snort3 installed on, it will analyse network traffic and log alerts based on signatures.
We’ll have 3 virtual network interfaces defined on this VM, one of which will be connected to our Management segment so we’ll be able to SSH to the machine from our hypervisor host and will also be used by the VM to forward alerts to our SIEM VM.  The other two interfaces will be used by Snort3 in AFPACKET bridging mode and will not be assigned IP addresses.
This AFPACKET bridge allows us to quickly quarantine the IPS2 segment of the network from the rest of the lab in the case that any malware is able to identify and attack other hosts on the network.

## Flare & Remnux VMs
These are both of the VMs which we’ll actually use to do our malware analysis, Flare being an installer package for Windows VMs providing malware analysis tools, Remnux a distro with malware analysis & reverse engineering tools for Unix.
